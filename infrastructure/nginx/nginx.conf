events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/json;

    # --- UPSTREAMS (Backend Services) ---
    upstream identity { server identity-service:8080; }
    upstream medical { server medical-record-service:8080; }
    upstream imaging { server imaging-service:8080; }
    upstream billing { server billing-service:8080; }
    upstream notification { server notification-service:8080; }
    upstream aicore { server aicore-service:8001; }

    server {
        listen 80;
        server_name localhost;

        # --- CẤU HÌNH CORS (Sửa lỗi cú pháp: đặt header trực tiếp trong location) ---
        location / {
            # Khi trình duyệt gửi request OPTIONS (Preflight)
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*';
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
                # Chú ý: Dòng add_header trong if block chỉ hoạt động ở version mới hoặc ngữ cảnh đặc biệt
                # Để an toàn nhất, ta trả về 204 luôn mà không add header phức tạp ở đây nếu gặp lỗi
                return 204;
            }

            # Các request bình thường
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
            
            return 404; # Mặc định trả về 404 nếu không khớp API nào bên dưới
        }

        # --- ROUTING API ---

        location /api/auth {
            proxy_pass http://identity;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/patients {
            proxy_pass http://medical;
        }
        
        location /api/examinations {
            proxy_pass http://medical;
        }

        location /api/medical-histories {
            proxy_pass http://medical;
        }

        location /api/images {
            proxy_pass http://imaging;
            client_max_body_size 10M;
        }

        location /api/bills {
            proxy_pass http://billing;
        }

        location /api/notifications {
            proxy_pass http://notification;
        }

        # AI Core Routing
        location /api/ai/ {
            # Xóa prefix /api/ai/ trước khi gửi vào service Python
            rewrite ^/api/ai/(.*) /$1 break;
            proxy_pass http://aicore;
            proxy_read_timeout 300s;
        }
    }
}