events {
    worker_connections 1024;
}

http {
    sendfile on;
    client_max_body_size 50M;

    include /etc/nginx/mime.types; 
    default_type application/octet-stream;
    
    error_log /var/log/nginx/error.log debug;

    server {
        listen 80;
        server_name localhost;

        add_header Cross-Origin-Opener-Policy "same-origin-allow-popups" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # 0. FRONTEND (React)
        location / {
            # SỬA: Dùng tên Service "frontend" cho chuẩn mạng Docker
            proxy_pass http://frontend:3000;
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
        }

        # 1. Identity Service - AUTH
        location /api/auth/ {
            proxy_pass http://identity-service:8080/api/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- [QUAN TRỌNG] Route sửa lỗi 404 Users ---
        location /api/users/ {
            proxy_pass http://identity-service:8080/api/users/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # ---------------------------------------------------------

        # Route hỗ trợ Clinic Management
        location /api/identity/ {
            rewrite ^/api/identity/(.*)$ /$1 break;
            proxy_pass http://identity-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/identity;
        }

        # 2. Medical Record Service
        location /api/patients/ {
            proxy_pass http://medical-record-service:8080/api/patients/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/examinations/ {
            proxy_pass http://medical-record-service:8080/api/examinations/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/medical-records/ {
            proxy_pass http://medical-record-service:8080/api/medical-records/;
            proxy_set_header Host $host;
        }

        location /api/medical-record/ {
            rewrite ^/api/medical-record/(.*)$ /$1 break;
            proxy_pass http://medical-record-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/medical-record;
        }

        # 3. Imaging Service 
        location /api/imaging/ {
            proxy_pass http://imaging-service:8080/api/imaging/;
            proxy_set_header Host $host;
        }

        # 4. Billing Service
        location /api/bills/ {
            proxy_pass http://billing-service:8080/api/bills/;
            proxy_set_header Host $host;
        }
        
        location /api/billing/ {
            rewrite ^/api/billing/(.*)$ /$1 break;
            proxy_pass http://billing-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/billing;
        }

        # 5. Notification Service
        location /api/notifications/ {
            proxy_pass http://notification-service:8080/api/notifications/;
            proxy_set_header Host $host;
        }

        location /api/notification/ {
            rewrite ^/api/notification/(.*)$ /$1 break;
            proxy_pass http://notification-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/notification;
        }
    }
}