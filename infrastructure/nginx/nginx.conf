events {
    worker_connections 1024;
}

http {
    # Tối ưu hóa xử lý request
    sendfile on;
    
    # Cấu hình để hỗ trợ upload file lớn (quan trọng cho Imaging Service)
    client_max_body_size 50M; 

    server {
        listen 80;
        server_name localhost;


        # 1. API Đăng nhập/Token
        location /api/auth/ {
            proxy_pass http://identity-service:8080/api/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # 2. API Hồ sơ bệnh nhân
        location /api/patients/ {
            proxy_pass http://medical-record-service:8080/api/patients/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 3. API Xử lý ảnh (Imaging)
        location /api/images/ {
            proxy_pass http://imaging-service:8080/api/images/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 4. API Hóa đơn (Billing)
        location /api/bills/ {
            proxy_pass http://billing-service:8080/api/bills/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # 5. API Thông báo (Notification)
        location /api/notifications/ {
            proxy_pass http://notification-service:8080/api/notifications/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # =================================================================
        # Cơ chế: Rewrite đường dẫn để trỏ về root của từng service
        # =================================================================

        # Truy cập: http://localhost/api/identity/swagger
        location /api/identity/ {
            rewrite ^/api/identity/(.*)$ /$1 break;
            proxy_pass http://identity-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/identity;
        }

        # Truy cập: http://localhost/api/imaging/swagger
        location /api/imaging/ {
            rewrite ^/api/imaging/(.*)$ /$1 break;
            proxy_pass http://imaging-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/imaging;
        }

        # Truy cập: http://localhost/api/medical-record/swagger
        location /api/medical-record/ {
            rewrite ^/api/medical-record/(.*)$ /$1 break;
            proxy_pass http://medical-record-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/medical-record;
        }

        # Truy cập: http://localhost/api/billing/swagger
        location /api/billing/ {
            rewrite ^/api/billing/(.*)$ /$1 break;
            proxy_pass http://billing-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/billing;
        }

        # Truy cập: http://localhost/api/notification/swagger
        location /api/notification/ {
            rewrite ^/api/notification/(.*)$ /$1 break;
            proxy_pass http://notification-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/notification;
        }
    }
}