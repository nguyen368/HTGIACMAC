events {
    worker_connections 1024;
}

http {
    sendfile on;
    # Đảm bảo Gateway hiểu định dạng file CSS/JS
    include /etc/nginx/mime.types;
    # Hỗ trợ upload ảnh võng mạc dung lượng lớn
    client_max_body_size 50M; 

    server {
        listen 80;
        server_name localhost;

        # -----------------------------------------------------------------
        # 0. ĐIỀU HƯỚNG VỀ FRONTEND (React App)
        # -----------------------------------------------------------------
        location / {
            proxy_pass http://frontend:80; 
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # -----------------------------------------------------------------
        # 1. CÁC API DỊCH VỤ (Proxies)
        # -----------------------------------------------------------------

        # Identity Service (Auth)
        location /api/auth/ {
            proxy_pass http://identity-service:8080/api/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Medical Record Service (Hồ sơ bệnh nhân)
        location /api/patients/ {
            proxy_pass http://medical-record-service:8080/api/patients/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Imaging Service (Xử lý ảnh)
        location /api/images/ {
            proxy_pass http://imaging-service:8080/api/images/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_read_timeout 300;
        }

        # Billing Service (Hóa đơn)
        location /api/bills/ {
            proxy_pass http://billing-service:8080/api/bills/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # Notification Service (Thông báo)
        location /api/notifications/ {
            proxy_pass http://notification-service:8080/api/notifications/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # -----------------------------------------------------------------
        # 2. CẤU HÌNH SWAGGER (Dành cho Debug)
        # -----------------------------------------------------------------

        location /api/identity/ {
            rewrite ^/api/identity/(.*)$ /$1 break;
            proxy_pass http://identity-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/identity;
        }

        location /api/imaging/ {
            rewrite ^/api/imaging/(.*)$ /$1 break;
            proxy_pass http://imaging-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/imaging;
        }

        location /api/medical-record/ {
            rewrite ^/api/medical-record/(.*)$ /$1 break;
            proxy_pass http://medical-record-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/medical-record;
        }

        location /api/billing/ {
            rewrite ^/api/billing/(.*)$ /$1 break;
            proxy_pass http://billing-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/billing;
        }

        location /api/notification/ {
            rewrite ^/api/notification/(.*)$ /$1 break;
            proxy_pass http://notification-service:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Prefix /api/notification;
        }
    }
}